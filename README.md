# ComfyUI深度感知背景虚化插件

一个专为ComfyUI设计的插件，利用深度图自动识别图像中的前景和背景，对背景应用精美的虚化效果，同时保持前景清晰。

## 主要功能

- **自动前景识别**：基于深度图自动分离前景和背景
- **多种虚化效果**：支持7种专业摄影级模糊效果
- **用户自定义保护**：通过掩码指定不需要虚化的区域
- **平滑过渡**：前景到背景的平滑自然过渡
- **高性能处理**：针对大图像的优化处理技术

## 支持的模糊效果

1. **高斯模糊**：传统的平滑模糊效果
2. **散景效果**：模拟相机光圈的散景虚化
3. **动态模糊**：模拟运动产生的模糊效果
4. **方框模糊**：类似像素化的方块模糊效果
5. **方向性模糊**：沿特定方向的模糊效果
6. **双重曝光**：将清晰图像与其模糊版本混合
7. **棱镜模糊**：分离RGB通道并添加位移，模拟色差

## 安装方法

1. 确保你已经安装了ComfyUI
2. 克隆或下载此仓库到你的ComfyUI自定义节点目录：
   ```
   cd ComfyUI/custom_nodes/
   git clone https://github.com/yourusername/comfyui-background-blur-X.git
   ```
3. 安装依赖：
   ```
   pip install opencv-python numpy torch
   ```
4. 重启ComfyUI

## 使用方法

### 基本用法

1. 在ComfyUI工作流中添加"深度感知背景虚化"节点
2. 连接输入图像和深度图
3. 调整参数以获得理想效果
4. 可选：提供保护掩码以指定不需要虚化的区域

### 输入说明

- **图像**：要处理的输入图像
- **深度图**：深度信息图，白色表示近处（前景），黑色表示远处（背景）
- **掩码**（可选）：用户自定义的保护区域，白色表示不需要虚化的区域

### 参数说明

- **背景模糊度**（0.0-100.0）：控制背景虚化的强度
- **背景虚化方式**：选择虚化效果的类型
  - 高斯模糊：传统的平滑模糊效果
  - 散景效果：模拟相机光圈的散景虚化
  - 动态模糊：模拟运动产生的模糊效果
  - 方框模糊：类似像素化的方块模糊效果
  - 方向性模糊：沿特定方向的模糊效果
  - 双重曝光：将清晰图像与其模糊版本混合
  - 棱镜模糊：分离RGB通道并添加位移，模拟色差
- **前景识别阈值**（0.0-1.0）：控制前景识别的敏感度，值越低前景区域越大
- **过渡平滑度**（0.0-1.0）：控制前景到背景的过渡效果，值越高过渡越平滑
- **掩码强度**（0.0-1.0）：控制用户掩码的影响程度
- **效果角度**（0.0-360.0）：控制某些效果（如方向性模糊）的方向
- **效果中心X**（0.0-1.0）：控制某些效果的中心点X坐标
- **效果中心Y**（0.0-1.0）：控制某些效果的中心点Y坐标
- **效果渐变**（0.0-1.0）：控制过渡区域的宽度/梯度
- **效果强度**（0.0-3.0）：控制效果的整体强度

## 高级效果使用建议

### 方向性模糊
- 适合模拟运动或加强方向感
- 使用"效果角度"设定模糊方向（0°为水平，90°为垂直）
- 调整"背景模糊度"和"效果强度"控制模糊量

### 双重曝光
- 使用"效果角度"值（0-3）切换不同混合模式：
  - 0: 正片叠底
  - 1: 屏幕混合
  - 2: 叠加混合
  - 3: 柔光混合
- 适合创造梦幻、复古效果

### 棱镜模糊
- 适合创造色差效果或强调高对比度区域
- 使用"效果角度"控制色差方向
- 增加"效果强度"加强通道分离程度

## 使用技巧

1. **深度图准备**
   - 理想的深度图应该有清晰的前景/背景分离
   - 可以使用ComfyUI中的深度估计节点生成深度图
   - 白色（255）表示最近的物体，黑色（0）表示最远的物体

2. **前景识别调整**
   - 如果前景区域太小，降低"前景识别阈值"
   - 如果前景区域太大，增加"前景识别阈值"

3. **平滑过渡**
   - 增加"过渡平滑度"可以避免前景/背景之间的硬边缘
   - 适当的平滑度可以创造更自然的虚化效果

4. **保护掩码使用**
   - 可以使用任何绘图工具创建黑白掩码
   - 白色区域会被保护不受虚化影响
   - 调整"掩码强度"控制保护的程度

5. **效果参数组合**
   - 有些效果需要多个参数协同工作才能达到最佳效果
   - 尝试不同的组合以获得独特的创意效果

## 示例工作流

以下是一个基本的使用示例：

1. 加载图像 → 深度估计 → 深度感知背景虚化 → 输出
2. 加载图像 → 深度估计 → 掩码生成 → 深度感知背景虚化 → 输出

## 常见问题

- **问题**：处理大图像时速度很慢
  **解决方案**：插件会自动对大图像进行分块处理，但处理时间仍会增加。如果速度是问题，可以先缩小图像。

- **问题**：背景虚化效果不理想
  **解决方案**：首先检查深度图质量，然后调整"前景识别阈值"和"背景模糊度"参数。

- **问题**：前景和背景之间有明显边界
  **解决方案**：增加"过渡平滑度"参数。

- **问题**：部分应该虚化的区域没有虚化
  **解决方案**：调整"前景识别阈值"或提供自定义掩码来精确控制虚化区域。

- **问题**：特殊效果不明显或太强烈
  **解决方案**：调整"效果强度"和"背景模糊度"参数，同时确保"效果角度"和"效果中心"设置正确。

## 技术细节

本插件使用OpenCV实现多种虚化效果，并采用了以下优化技术：

- 针对大图像的分块处理
- 边界平滑过渡避免拼接痕迹
- 多级错误处理和回退机制
- 逐通道处理避免形状不匹配问题

## 更新日志

### v2.0.0
- 移除部分模糊效果以提高处理性能
- 增加模糊强度最大值至100
- 优化分块处理性能

### v1.0.0
- 初始版本发布
- 支持四种基础虚化风格
- 自动前景识别和用户掩码功能

## 许可证

MIT

## 作者

您的名字与联系方式 